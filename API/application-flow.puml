@startuml Application Flow
!theme plain
skinparam backgroundColor #FFFFFF
skinparam defaultTextAlignment center

title Status Indicator API - Application Flow

actor "Admin" as admin
actor "User Device" as device
participant "Tauri Tray App\n(Windows/macOS)" as tray
participant "FastAPI\n(Port 9759)" as api
database "PostgreSQL" as db
database "Redis Cache" as redis
participant "APScheduler\n(Background)" as scheduler
participant "Gmail SMTP" as email

== Device Creation (One-time Admin Setup) ==

admin -> api: POST /api/v1/devices\nX-Master-Key: {master_key}
activate api
api -> api: Verify master API key
api -> api: Generate device API key\n(random 32-char token)
api -> db: INSERT device\n(hash API key with bcrypt)
activate db
db --> api: Device created
deactivate db
api --> admin: Return plaintext API key\n(store securely, shown once!)
deactivate api

== Tray App Initialization ==

device -> tray: Start application\n(auto-start on boot)
activate tray
tray -> tray: Load settings from\ntauri-plugin-store\n(API URL + API key)
tray -> api: POST /api/v1/ping\nX-API-Key: {device_key}\n(immediate startup ping)
activate api
api -> api: Verify device API key\n(bcrypt compare)
alt Valid API key
    api -> db: INSERT status_ping
    activate db
    db --> api: Ping recorded
    deactivate db
    api -> db: UPDATE device_status\nSET last_ping_at = NOW()
    activate db
    db --> api: Status updated
    deactivate db
    api -> redis: DELETE cache key\ndevice_status:{device_id}
    activate redis
    redis --> api: Cache invalidated
    deactivate redis
    api --> tray: 200 OK
else Invalid API key
    api -> email: Send security alert\nto admin email
    activate email
    email --> api: Alert sent
    deactivate email
    api --> tray: 401 Unauthorized
    tray -> tray: Show error notification
end
deactivate api
tray -> tray: Start background loop\n(ping every 5 minutes)
deactivate tray

== Regular Ping Cycle ==

loop Every 5 minutes
    tray -> api: POST /api/v1/ping\nX-API-Key: {device_key}
    activate tray
    activate api
    api -> api: Authenticate device
    api -> db: INSERT status_ping
    activate db
    db --> api: Success
    deactivate db
    api -> db: UPDATE device_status\nlast_ping_at
    activate db
    db --> api: Updated
    deactivate db
    api -> redis: Invalidate cache
    activate redis
    redis --> api: Cache cleared
    deactivate redis
    api --> tray: 200 OK
    deactivate api
    deactivate tray
end

== Background Status Monitoring ==

loop Every 5 minutes (APScheduler)
    scheduler -> db: SELECT * FROM device_status\nWHERE last_ping_at < NOW() - 20 minutes
    activate scheduler
    activate db
    db --> scheduler: Offline devices list
    deactivate db
    
    alt Devices went offline
        scheduler -> db: UPDATE device_status\nSET status = 'offline'
        activate db
        db --> scheduler: Status updated
        deactivate db
        scheduler -> redis: Bulk DELETE\ndevice_status:{device_id}
        activate redis
        redis --> scheduler: Caches invalidated
        deactivate redis
    end
    deactivate scheduler
end

== Status Query (with Redis Caching) ==

device -> api: GET /api/v1/status
activate api
api -> redis: GET device_status:*
activate redis
alt Cache hit
    redis --> api: Cached status data
    deactivate redis
    api -> api: Calculate\ntime_since_last_ping_seconds
    api --> device: Return cached status\n+ time_since_last_ping_seconds
else Cache miss
    redis --> api: null
    deactivate redis
    api -> db: SELECT * FROM device_status
    activate db
    db --> api: Current status data
    deactivate db
    api -> api: Calculate\ntime_since_last_ping_seconds
    api -> redis: SET device_status:{device_id}\nEX 300 (5-min TTL)
    activate redis
    redis --> api: Cached
    deactivate redis
    api --> device: Return status\n+ time_since_last_ping_seconds
end
deactivate api

== Manual Actions ==

device -> tray: Right-click tray icon\nâ†’ "Ping Now"
activate tray
tray -> api: POST /api/v1/ping\n(manual trigger)
activate api
api -> db: Record ping
activate db
db --> api: Success
deactivate db
api -> redis: Invalidate cache
activate redis
redis --> api: Cleared
deactivate redis
api --> tray: 200 OK
deactivate api
tray -> tray: Show success notification
deactivate tray

@enduml
